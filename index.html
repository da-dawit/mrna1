<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Interactive Ribosome Assembly</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Arial', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* UI Overlay */
        #ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            pointer-events: auto;
            border: 1px solid #444;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        h1 { margin: 0 0 10px 0; font-size: 18px; font-weight: 600; color: #ecf0f1; border-bottom: 1px solid #555; padding-bottom: 10px; }
        p { font-size: 13px; color: #bdc3c7; line-height: 1.4; }
        
        .control-group { margin-top: 20px; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #3498db; }
        
        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: #444;
            height: 6px;
            border-radius: 3px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            transition: background .15s ease-in-out;
        }
        input[type=range]::-webkit-slider-thumb:hover { background: #5dade2; }
        
        .legend { margin-top: 20px; font-size: 12px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        
        /* Loading Overlay */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; pointer-events: none;
        }
    </style>
    <!-- Import Map to resolve 'three' dependencies -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading">Loading 3D Engine...</div>
    <div id="canvas-container"></div>

    <div id="ui-panel">
        <h1>Ribosome Initiation Complex</h1>
        <p>Interactive 3D model of the 80S ribosome assembling on the mRNA start codon.</p>
        
        <div class="control-group">
            <label for="assemblySlider">ASSEMBLY PROGRESS</label>
            <input type="range" id="assemblySlider" min="0" max="100" value="0">
            <p id="statusText" style="margin-top:5px; font-style:italic; color:#f1c40f;">State: Scanning...</p>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="dot" style="background:#1abc9c;"></div>40S Subunit (Small)</div>
            <div class="legend-item"><div class="dot" style="background:#8e44ad;"></div>60S Subunit (Large)</div>
            <div class="legend-item"><div class="dot" style="background:#e67e22;"></div>Met-tRNA (P-Site)</div>
            <div class="legend-item"><div class="dot" style="background:#e74c3c;"></div>Start Codon (AUG)</div>
        </div>
        
        <p style="margin-top:20px; font-size:11px; color:#7f8c8d;">
            • Left Click: Rotate<br>
            • Right Click: Pan<br>
            • Scroll: Zoom
        </p>
    </div>

    <!-- Main Script -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- SCENE SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        scene.fog = new THREE.Fog(0x1a1a1a, 20, 100);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 30);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // --- CONTROLS ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 10;
        controls.maxDistance = 100;

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);
        
        const spotLight = new THREE.SpotLight(0xffffff, 0.5);
        spotLight.position.set(-10, 10, -5);
        scene.add(spotLight);

        // --- MATERIALS ---
        const mat40S = new THREE.MeshPhongMaterial({ 
            color: 0x1abc9c, 
            shininess: 30,
            transparent: true,
            opacity: 0.9,
            flatShading: false
        });
        
        const mat60S = new THREE.MeshPhongMaterial({ 
            color: 0x8e44ad, 
            shininess: 30,
            transparent: true,
            opacity: 0.9,
            flatShading: false
        });

        const matRNA = new THREE.MeshStandardMaterial({ color: 0xecf0f1, roughness: 0.7 });
        const matCap = new THREE.MeshStandardMaterial({ color: 0xe67e22, emissive: 0x331100 });
        const matAUG = new THREE.MeshStandardMaterial({ color: 0xe74c3c, emissive: 0x550000 });
        const mattRNA = new THREE.MeshPhongMaterial({ color: 0xf39c12 });

        // --- GEOMETRY GENERATION ---

        // 1. Generate mRNA Strand
        const mRNA = new THREE.Group();
        scene.add(mRNA);

        const seqLength = 40;
        const curvePoints = [];
        
        // Create a slightly wavy path for natural look
        for(let i = 0; i < seqLength; i++) {
            const x = (i - seqLength/2) * 1.5;
            const y = Math.sin(i * 0.3) * 0.5;
            const z = Math.cos(i * 0.2) * 0.5;
            curvePoints.push(new THREE.Vector3(x, y, z));
        }
        
        const curve = new THREE.CatmullRomCurve3(curvePoints);
        const tubeGeo = new THREE.TubeGeometry(curve, 64, 0.15, 8, false);
        const tubeMesh = new THREE.Mesh(tubeGeo, matRNA);
        tubeMesh.castShadow = true;
        mRNA.add(tubeMesh);

        // Add Bases (Sticks)
        const baseGeo = new THREE.CylinderGeometry(0.1, 0.1, 1, 6);
        const startCodonIndex = 20; // Center of strand roughly

        for(let i = 0; i < seqLength; i++) {
            const t = i / (seqLength - 1);
            const pos = curve.getPoint(t);
            const tangent = curve.getTangent(t);
            
            const baseMesh = new THREE.Mesh(baseGeo, (i >= startCodonIndex && i < startCodonIndex+3) ? matAUG : matRNA);
            baseMesh.position.copy(pos);
            
            // Orient perpendicular to curve
            const axis = new THREE.Vector3(0, 1, 0);
            baseMesh.quaternion.setFromUnitVectors(axis, tangent);
            baseMesh.rotateX(Math.PI / 2);
            
            // Random rotation around the wire for non-AUG
            if(i < startCodonIndex || i >= startCodonIndex+3) {
                 baseMesh.rotateZ(Math.random() * Math.PI * 2);
            } else {
                 // Align AUG upwards for visibility
                 baseMesh.rotation.z = 0; 
            }

            mRNA.add(baseMesh);
        }

        // Add 5' Cap
        const capGeo = new THREE.SphereGeometry(0.6, 16, 16);
        const capMesh = new THREE.Mesh(capGeo, matCap);
        capMesh.position.copy(curve.getPoint(0));
        mRNA.add(capMesh);

        // 2. Generate Ribosome Parts (Procedural Blobs)
        
        // Helper to create blobby molecular shapes
        function createBlob(radius, detail, distortion) {
            const geo = new THREE.IcosahedronGeometry(radius, detail);
            const posAttribute = geo.attributes.position;
            
            // Perturb vertices for organic look
            for (let i = 0; i < posAttribute.count; i++) {
                const x = posAttribute.getX(i);
                const y = posAttribute.getY(i);
                const z = posAttribute.getZ(i);
                
                // Simple noise-like distortion
                const noise = Math.sin(x * 2) * Math.sin(y * 2) * Math.sin(z * 2);
                const factor = 1 + (noise * distortion);
                
                posAttribute.setXYZ(i, x * factor, y * factor, z * factor);
            }
            geo.computeVertexNormals();
            return geo;
        }

        const ribosomeGroup = new THREE.Group();
        scene.add(ribosomeGroup);

        // 40S Subunit
        const geo40S = createBlob(3, 1, 0.2);
        // Flatten slightly
        geo40S.scale(1.2, 0.8, 1);
        const mesh40S = new THREE.Mesh(geo40S, mat40S);
        mesh40S.castShadow = true;
        mesh40S.receiveShadow = true;
        
        // 60S Subunit
        const geo60S = createBlob(4.5, 1, 0.15);
        const mesh60S = new THREE.Mesh(geo60S, mat60S);
        mesh60S.castShadow = true;
        mesh60S.receiveShadow = true;
        
        // tRNA (Met) - L Shape
        const tRNAGroup = new THREE.Group();
        const arm1 = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 3, 8), mattRNA);
        const arm2 = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 2, 8), mattRNA);
        arm2.rotation.z = Math.PI / 2;
        arm2.position.set(0.8, 1.3, 0);
        tRNAGroup.add(arm1);
        tRNAGroup.add(arm2);
        
        // Position parts relative to center
        ribosomeGroup.add(mesh40S);
        ribosomeGroup.add(mesh60S);
        ribosomeGroup.add(tRNAGroup);

        // Initial Positions
        // 40S sits "under" the mRNA
        mesh40S.position.set(0, -1.5, 0);
        
        // tRNA sits in the P-site (between subunits)
        tRNAGroup.position.set(0, 0.5, 0);
        tRNAGroup.rotation.set(0, Math.PI/2, 0.5);

        // 60S sits "above", but we will control its Y position with the slider
        mesh60S.position.set(0, 15, 0); // Start high up

        // --- ANIMATION & INTERACTION LOGIC ---
        
        const augPos = curve.getPoint(startCodonIndex / seqLength);
        const startPos = curve.getPoint(0.1); // Start of scanning
        
        const slider = document.getElementById('assemblySlider');
        const statusText = document.getElementById('statusText');

        function updateModel() {
            const val = parseInt(slider.value);
            const progress = val / 100;

            // Phase 1: Scanning (0-50%)
            // Move 40S + tRNA along the curve to AUG
            if (progress <= 0.5) {
                const scanFactor = progress * 2; // 0 to 1
                
                // Interpolate position from startPos to augPos
                const currentPos = new THREE.Vector3().lerpVectors(startPos, augPos, scanFactor);
                
                ribosomeGroup.position.copy(currentPos);
                
                // Keep 60S away
                mesh60S.position.y = 15;
                mesh60S.visible = false;
                
                statusText.innerText = "State: 40S Scanning for Start Codon...";
                statusText.style.color = "#f39c12";
            } 
            // Phase 2: Assembly (50-100%)
            // Lock at AUG, bring 60S down
            else {
                ribosomeGroup.position.copy(augPos);
                mesh60S.visible = true;
                
                const assemblyFactor = (progress - 0.5) * 2; // 0 to 1
                
                // Lerp 60S Y position from 15 (high) to 3.5 (assembled)
                mesh60S.position.y = THREE.MathUtils.lerp(15, 3.5, assemblyFactor);
                
                if(progress > 0.95) {
                    statusText.innerText = "State: 80S Complex Assembled!";
                    statusText.style.color = "#2ecc71";
                } else {
                    statusText.innerText = "State: 60S Subunit Joining...";
                    statusText.style.color = "#8e44ad";
                }
            }
        }

        // --- RENDER LOOP ---
        document.getElementById('loading').style.display = 'none';
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updateModel();
            
            // Subtle floating animation for the whole complex
            const time = Date.now() * 0.001;
            mRNA.rotation.x = Math.sin(time * 0.2) * 0.05;
            
            renderer.render(scene, camera);
        }
        
        animate();

        // Handle Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>